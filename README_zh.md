# Code Interpreter APIï¼šä¸€ä¸ªæœ‰çŠ¶æ€ã€é«˜å®‰å…¨ã€é«˜æ€§èƒ½çš„ä»£ç æ²™ç®±

[English](README.md)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé€šè¿‡ API é©±åŠ¨çš„ã€ä¸ºå®ç°**é«˜å®‰å…¨æ€§ã€æœ‰çŠ¶æ€ä¼šè¯ç®¡ç†å’Œå¼ºå¤§æ€§èƒ½**è€Œè®¾è®¡çš„ä»£ç æ‰§è¡Œæ²™ç®±ã€‚å®ƒé‡‡ç”¨ä¸­å¿ƒåŒ–çš„ **API ç½‘å…³ (Gateway)** å’ŒåŠ¨æ€çš„ **å·¥ä½œå®ä¾‹æ±  (Worker Pool)** æ¶æ„ï¼Œä¸ºæ¯ä¸ªç”¨æˆ·æä¾›ä¸€ä¸ªå®Œå…¨éš”ç¦»çš„ã€æŒä¹…åŒ–çš„æ‰§è¡Œä¼šè¯ã€‚

**å…¨æ–°åŒè¿è¡Œæ—¶æ”¯æŒ**ï¼šPython 3.12 å’Œ Node.js 18 LTSï¼Œä»¥åŠå…¨é¢çš„æ–‡æ¡£å¤„ç†ã€æµè§ˆå™¨è‡ªåŠ¨åŒ–å’Œ 140+ é¢„è£…åº“ã€‚

æœ¬é¡¹ç›®çš„æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§ä¹‹ä¸€æ˜¯å…¶æˆåŠŸå®ç°äº† **â€œæ¯ä¸ªå·¥ä½œå®ä¾‹ä¸€ä¸ªè™šæ‹Ÿç£ç›˜ (Virtual-Disk-per-Worker)â€** æ¶æ„ã€‚è¿™ä¸ªå…ˆè¿›çš„æ¨¡å‹åœ¨è¿è¡Œæ—¶ä¸ºæ¯ä¸ªå·¥ä½œå®¹å™¨åŠ¨æ€åœ°åˆ›å»ºã€æ ¼å¼åŒ–å¹¶é€šè¿‡ `losetup` æŒ‚è½½ä¸€ä¸ªä¸“å±çš„è™šæ‹Ÿç£ç›˜ã€‚è¯¥æ–¹æ³•è§£å†³äº†åœ¨å¹¶å‘å®¹å™¨åŒ–ç¯å¢ƒä¸­å¯é åœ°ç®¡ç†åŠ¨æ€å—è®¾å¤‡çš„é‡å¤§æŒ‘æˆ˜ï¼Œä»è€Œå®ç°äº†å“è¶Šçš„ I/O å’Œæ–‡ä»¶ç³»ç»Ÿéš”ç¦»ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªç³»ç»Ÿå®‰å…¨æ€åŠ¿çš„åŸºçŸ³ã€‚

æ¯ä¸ªå·¥ä½œå®ä¾‹éƒ½è¢«ä¸€ä¸ªå¤šå±‚å®‰å…¨æ¨¡å‹æ²™ç®±åŒ–ï¼Œè¯¥æ¨¡å‹åŒ…æ‹¬ä¸¥æ ¼çš„èµ„æºé™åˆ¶ã€é›¶ä¿¡ä»»ç½‘ç»œç­–ç•¥å’Œè¿è¡Œæ—¶æƒé™é™çº§ã€‚é€šè¿‡åˆ©ç”¨å†…éƒ¨çš„ Jupyter Kernelï¼Œå®ƒèƒ½å¤Ÿåœ¨å¤šæ¬¡ API è°ƒç”¨ä¹‹é—´ä¿æŒå®Œæ•´çš„ä»£ç æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå˜é‡ã€å¯¼å…¥ã€å‡½æ•°ï¼‰ï¼Œç¡®ä¿äº†ä¼šè¯çš„è¿ç»­æ€§ã€å®‰å…¨æ€§å’Œé«˜æ€§èƒ½ã€‚

## æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | æˆ‘ä»¬çš„å®ç° | æ ‡å‡†å®ç° (å¸¸è§æƒè¡¡) |
| :--- | :--- | :--- |
| **ğŸš€ æ€§èƒ½** | é¢„çƒ­çš„å·¥ä½œå®ä¾‹æ± ç¡®ä¿äº†ä¼šè¯çš„å³æ—¶åˆ†é…ã€‚å…¨å¼‚æ­¥è®¾è®¡ (FastAPI, httpx) æä¾›äº†é«˜ååé‡ (çº¦ 32.8 RPS) å’Œä½å»¶è¿Ÿã€‚ | ä¸ºæ¯ä¸ªæ–°ä¼šè¯æŒ‰éœ€å¯åŠ¨å®¹å™¨/ç¯å¢ƒï¼Œå¯¼è‡´é«˜å»¶è¿Ÿã€‚é€šå¸¸é‡‡ç”¨åŒæ­¥è®¾è®¡ï¼Œåœ¨é«˜è´Ÿè½½ä¸‹å¹¶å‘èƒ½åŠ›å·®ã€‚ |
| **ğŸ”’ å®‰å…¨æ€§** | å¤šå±‚é›¶ä¿¡ä»»å®‰å…¨æ¨¡å‹ï¼šæ— äº’è”ç½‘è®¿é—® (`internal: true`)ã€å·¥ä½œå®ä¾‹é—´é˜²ç«å¢™ (`iptables`)ã€ç½‘å…³ä¸å¯è®¿é—®ã€æƒé™é™çº§ (`root` to `sandbox`)ã€‚ | åŸºç¡€çš„å®¹å™¨åŒ–é€šå¸¸å…è®¸å‡ºç«™äº’è”ç½‘è®¿é—®ï¼Œç¼ºå°‘å®ä¾‹é—´é˜²ç«å¢™ï¼ˆå­˜åœ¨æ¨ªå‘ç§»åŠ¨é£é™©ï¼‰ï¼Œä¸”å¯èƒ½ä»¥è¿‡é«˜æƒé™è¿è¡Œä»£ç ã€‚ |
| **ğŸ”„ çŠ¶æ€ä¿æŒ** | çœŸæ­£çš„ä¼šè¯æŒä¹…åŒ–ã€‚æ¯ä¸ªç”¨æˆ·è¢«æ˜ å°„åˆ°ä¸€ä¸ªä¸“ç”¨çš„ã€æ‹¥æœ‰æŒä¹…åŒ– Jupyter Kernel çš„å·¥ä½œå®ä¾‹ï¼Œåœ¨æ‰€æœ‰ API è°ƒç”¨é—´ä¿æŒå®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚ | æ— çŠ¶æ€ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯æ–°ç¯å¢ƒï¼‰ï¼Œæˆ–é€šè¿‡åºåˆ—åŒ–ç­‰æ–¹å¼æ¨¡æ‹ŸçŠ¶æ€ï¼ˆé€šå¸¸é€Ÿåº¦æ…¢ä¸”ä¸å®Œæ•´ï¼‰ã€‚ |
| **ğŸ› ï¸ å¯é æ€§** | â€œç‰²ç•œï¼Œè€Œéå® ç‰©â€çš„æ•…éšœæ¢å¤æ¨¡å‹ã€‚ç½‘å…³å¼ºåˆ¶æ‰§è¡Œç¡¬æ€§è¶…æ—¶å¹¶ç›‘æ§å·¥ä½œå®ä¾‹å¥åº·ã€‚ä»»ä½•å¤±è´¥ã€å¡æ­»æˆ–å´©æºƒçš„å®ä¾‹éƒ½ä¼šè¢«ç«‹å³é”€æ¯å’Œæ›¿æ¢ã€‚ | å·¥ä½œå®ä¾‹å¸¸è¢«è§†ä¸ºéœ€è¦â€œä¿®å¤â€çš„çŠ¶æ€åŒ–å® ç‰©ï¼Œå¯¼è‡´å¤æ‚çš„æ¢å¤é€»è¾‘ï¼Œå¹¶å¢åŠ äº†æ±¡æŸ“æˆ–ä¸ä¸€è‡´çŠ¶æ€æŒç»­å­˜åœ¨çš„é£é™©ã€‚ |
| **ğŸ’¡ I/O éš”ç¦»**| **æ¯ä¸ªå·¥ä½œå®ä¾‹ä¸€ä¸ªè™šæ‹Ÿç£ç›˜**ã€‚æ¯ä¸ªå·¥ä½œå®ä¾‹éƒ½æ‹¥æœ‰è‡ªå·±åŠ¨æ€æŒ‚è½½çš„å—è®¾å¤‡ï¼Œæä¾›äº†ä¸ä¸»æœºå’Œå…¶ä»–å·¥ä½œå®ä¾‹ä¹‹é—´çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿå’Œ I/O éš”ç¦»ã€‚ | é€šå¸¸ä¾èµ–äºå…±äº«çš„ä¸»æœºå·ï¼ˆå­˜åœ¨äº¤å‰è¯»å†™å’Œå®‰å…¨æ¼æ´çš„é£é™©ï¼‰ï¼Œæˆ–è€…å®Œå…¨æ²¡æœ‰æŒä¹…åŒ–çš„éš”ç¦»å­˜å‚¨ã€‚ |

## å†…ç½®èƒ½åŠ›

æ¯ä¸ªå·¥ä½œå®ä¾‹éƒ½é¢„è£…äº†å…¨é¢çš„å·¥å…·å’Œåº“ã€‚å®Œæ•´åˆ—è¡¨è¯·å‚è§ [`worker/CAPABILITIES.md`](worker/CAPABILITIES.md)ã€‚

### è¿è¡Œæ—¶ç¯å¢ƒ

| è¿è¡Œæ—¶ | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| **Python** | 3.12.12 | ä¸»æ‰§è¡Œç¯å¢ƒï¼Œé…åˆ Jupyter Kernel |
| **Node.js** | 18 LTS | é€šè¿‡å­è¿›ç¨‹æ‰§è¡Œ JavaScript/TypeScript |

### é¢„è£…åº“ (140+)

| ç±»åˆ« | ä¸»è¦åº“ | èƒ½åŠ› |
|------|--------|------|
| **ç§‘å­¦è®¡ç®—** | numpy, pandas, scipy, scikit-learn, statsmodels | æ•°æ®åˆ†æã€æœºå™¨å­¦ä¹ ã€ç»Ÿè®¡ |
| **æ•°æ®å¯è§†åŒ–** | matplotlib, seaborn, plotly, pyecharts, wordcloud | å›¾è¡¨ã€å›¾å½¢ã€äº¤äº’å¼ç»‘å›¾ |
| **å›¾åƒå¤„ç†** | PIL, OpenCV, scikit-image, ImageMagick, rawpy | å›¾åƒç¼–è¾‘ã€è®¡ç®—æœºè§†è§‰ã€RAW å¤„ç† |
| **è§†é¢‘å¤„ç†** | moviepy, ffmpeg-python, PyAV, vidgear | è§†é¢‘ç¼–è¾‘ã€ç¼–ç ã€æµå¤„ç† |
| **éŸ³é¢‘å¤„ç†** | pydub, librosa, soundfile, pedalboard | éŸ³é¢‘ç¼–è¾‘ã€åˆ†æã€æ•ˆæœ |
| **æ–‡æ¡£å¤„ç†** | python-docx, openpyxl, python-pptx, PyPDF2, pdfplumber | Office æ–‡æ¡£ã€PDF æ“ä½œ |
| **æ–‡æœ¬ä¸ NLP** | jieba, pypinyin, thefuzz, faker | ä¸­æ–‡ NLPã€æ¨¡ç³ŠåŒ¹é… |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | Playwright + Chromium | ç½‘é¡µæŠ“å–ã€æˆªå›¾ã€æµ‹è¯• |

### ç³»ç»Ÿå·¥å…·

| å·¥å…· | ç‰ˆæœ¬ | èƒ½åŠ› |
|------|------|------|
| **LibreOffice** | æœ€æ–° | æ–‡æ¡£è½¬æ¢ (docx/xlsx/pptx â†” PDF) |
| **Pandoc** | æœ€æ–° | é€šç”¨æ–‡æ¡£è½¬æ¢å™¨ (Markdown, LaTeX ç­‰) |
| **FFmpeg** | æœ€æ–° | éŸ³è§†é¢‘ç¼–ç ã€è½¬ç ã€æµå¤„ç† |
| **ImageMagick** | æœ€æ–° | å›¾åƒè½¬æ¢ (200+ æ ¼å¼) |
| **Tesseract OCR** | æœ€æ–° | æ–‡å­—è¯†åˆ« (è‹±æ–‡ + ä¸­æ–‡) |
| **Poppler** | æœ€æ–° | PDF å·¥å…· (pdftotext, pdftoppm ç­‰) |
| **Ghostscript** | æœ€æ–° | PDF/PostScript å¤„ç† |

### Node.js å…¨å±€åŒ…

| åŒ… | ç”¨é€” |
|----|------|
| `docx` | Word æ–‡æ¡£åˆ›å»º |
| `pptxgenjs` | PowerPoint ç”Ÿæˆ |
| `typescript` | TypeScript ç¼–è¯‘å™¨ |
| `ts-node` | ç›´æ¥æ‰§è¡Œ TypeScript |

## æ€§èƒ½åŸºå‡†æµ‹è¯•

ä¸ºäº†éªŒè¯å…¶åœ¨çœŸå®åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§ï¼Œæˆ‘ä»¬åœ¨ä¸­ç«¯æ¡Œé¢å¹³å°ä¸Šè¿›è¡Œäº†å‹åŠ›æµ‹è¯•ã€‚

### **æµ‹è¯•é…ç½®ï¼šä¸­ç«¯æ¡Œé¢å¹³å° (Intel i5-14400, 16GB å†…å­˜)**

-   **æµ‹è¯•åœºæ™¯**: æ¨¡æ‹Ÿ **25 ä¸ªå¹¶å‘ç”¨æˆ·**ï¼Œæ¯ä¸ªç”¨æˆ·å‘é€ 100 æ¬¡æœ‰çŠ¶æ€çš„è¯·æ±‚ï¼ˆå¹¶åœ¨æ¯ä¸€æ­¥éªŒè¯ç»“æœçš„æ­£ç¡®æ€§ï¼‰ã€‚
-   **æ€»è¯·æ±‚æ•°**: 2,500
-   **ååé‡ (RPS)**: **çº¦ 32.8 è¯·æ±‚/ç§’**
-   **è¯·æ±‚æˆåŠŸç‡**: **100%**
-   **çŠ¶æ€éªŒè¯æˆåŠŸç‡**: **100%**
-   **P95 å»¶è¿Ÿ**: **496.50 æ¯«ç§’**
-   **æµ‹è¯•å‚æ•°**: æœ¬æ¬¡åŸºå‡†æµ‹è¯•åœ¨ä»¥ä¸‹è¿è¡Œæ—¶é…ç½®ä¸‹è¿›è¡Œï¼š
    -   æœ€å°ç©ºé—²å®ä¾‹æ•° (`MinIdleWorkers`): 5
    -   æœ€å¤§å®ä¾‹æ€»æ•° (`MaxTotalWorkers`): 30
    -   å·¥ä½œå®ä¾‹CPUé™åˆ¶ (`WorkerCPU`): 1.0 æ ¸
    -   å·¥ä½œå®ä¾‹å†…å­˜é™åˆ¶ (`WorkerRAM_MB`): 1024 MB
    -   å·¥ä½œå®ä¾‹ç£ç›˜å¤§å° (`WorkerDisk_MB`): 500 MB

### æµ‹è¯•ç»“æœå›¾è¡¨

![æµ‹è¯•ç»“æœæ¦‚è§ˆé¥¼å›¾](images/1_test_summary_pie_chart.png)![å»¶è¿Ÿåˆ†å¸ƒå›¾](images/2_latency_distribution_chart.png)

## æ¶æ„è§£æ

1.  **API ç½‘å…³ (Gateway)**: å”¯ä¸€çš„ã€éœ€è®¤è¯çš„å…¥å£ã€‚å…¶ `WorkerPool` æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¤§è„‘ï¼Œç®¡ç†å·¥ä½œå®ä¾‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ä¸ºå…¶åŠ¨æ€åˆ›å»ºè™šæ‹Ÿç£ç›˜çš„å¤æ‚è¿‡ç¨‹ã€‚å®ƒæ‰®æ¼”ç€å¯ä¿¡çš„æ§åˆ¶å¹³é¢è§’è‰²ã€‚
2.  **å·¥ä½œå®ä¾‹ (Worker)**: ä¸€ä¸ªä¸å¯ä¿¡çš„ã€ä¸€æ¬¡æ€§çš„ä»£ç æ‰§è¡Œå•å…ƒã€‚å®ƒè¿è¡Œä¸€ä¸ª `Supervisor`ï¼Œä»¥ä¸€ä¸ªé root çš„ `sandbox` ç”¨æˆ·èº«ä»½ç®¡ç†ä¸¤ä¸ªå­è¿›ç¨‹ï¼ˆFastAPI æœåŠ¡, Jupyter Kernelï¼‰ã€‚åœ¨å¯åŠ¨æ—¶ï¼Œä¸€ä¸ªè„šæœ¬ä¼šå…ˆé…ç½®å¥½ `iptables` é˜²ç«å¢™ï¼ˆåªå…è®¸æ¥è‡ªç½‘å…³çš„æµé‡ï¼‰ï¼ŒæŒ‚è½½å…¶ä¸“å±è™šæ‹Ÿç£ç›˜ï¼Œç„¶åå†é™çº§æƒé™ã€‚

![é«˜å±‚ç³»ç»Ÿæ¶æ„å›¾](images/high_level_architecture_zh.png)![è¯·æ±‚æµç¨‹æ—¶åºå›¾](images/request_flow_sequence_zh.png)

## æ–‡ä»¶ä¼ è¾“æ¶æ„

ç³»ç»Ÿé€šè¿‡ç½‘å…³çš„**åŒæŒ‚è½½æ¶æ„**æä¾›å®‰å…¨ã€é«˜æ€§èƒ½çš„æ–‡ä»¶ä¼ è¾“èƒ½åŠ›ã€‚è¿™ç§è®¾è®¡å…è®¸ç½‘å…³ç›´æ¥è®¿é—®æ¯ä¸ªå·¥ä½œå®ä¾‹çš„æ²™ç®±æ–‡ä»¶ç³»ç»Ÿï¼Œæ— éœ€é€šè¿‡ä¸å¯ä¿¡çš„å·¥ä½œå®¹å™¨è·¯ç”±æµé‡ã€‚

### å·¥ä½œåŸç†

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚         å·¥ä½œå®¹å™¨ (Worker)            â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  å®¢æˆ·ç«¯   â”‚ â”€â”€â”€ é¢„ç­¾å URL â”€â”€â”€â”€â”€â”‚â”€â”€â”‚ /sandbox (å®¹å™¨å†…ç»‘å®šæŒ‚è½½)      â”‚  â”‚
   â”‚  (OSS)   â”‚                     â”‚  â”‚   â””â”€â”€ user_data.xlsx          â”‚  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚   â””â”€â”€ output.png              â”‚  â”‚
        â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                              â”‚
        â”‚                                              â”‚ (åŒä¸€å—è®¾å¤‡)
        â”‚                                              â–¼
        â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  HTTP PUT/GET             â”‚        ç½‘å…³å®¹å™¨ (Gateway)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                    â”‚  â”‚ /worker_mounts/{worker_id}/   â”‚  â”‚
                                    â”‚  â”‚   â””â”€â”€ user_data.xlsx          â”‚  â”‚
                                    â”‚  â”‚   â””â”€â”€ output.png              â”‚  â”‚
                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                    â”‚         (å®¿ä¸»æœºæŒ‚è½½ç‚¹)               â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

1.  **ä¸Šä¼ **ï¼šç½‘å…³ä»é¢„ç­¾å URLï¼ˆå¦‚ OSSï¼‰ä¸‹è½½æ–‡ä»¶ï¼Œå¹¶é€šè¿‡è‡ªå·±çš„æŒ‚è½½ç‚¹ï¼ˆ`/worker_mounts/{worker_id}/`ï¼‰ç›´æ¥å†™å…¥å·¥ä½œå®ä¾‹çš„è™šæ‹Ÿç£ç›˜ã€‚
2.  **å¯¼å‡º**ï¼šç½‘å…³ä»å…¶æŒ‚è½½ç‚¹è¯»å–æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°é¢„ç­¾å URLã€‚æ•°æ®æ°¸è¿œä¸ä¼šç»è¿‡ä¸å¯ä¿¡çš„å·¥ä½œè¿›ç¨‹ã€‚
3.  **åˆ é™¤**ï¼šç½‘å…³ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿåˆ é™¤æ–‡ä»¶ã€‚

### å®‰å…¨ç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ | é˜²èŒƒçš„å¨èƒ |
| :--- | :--- | :--- |
| **è·¯å¾„ç©¿è¶Šé˜²æŠ¤** | ä½¿ç”¨ `PurePosixPath.relative_to()` éªŒè¯æ‰€æœ‰è·¯å¾„éƒ½è§£æåœ¨ `/sandbox` å†…ã€‚æ‹’ç»åŒ…å« `/` æˆ– `\` çš„æ–‡ä»¶åã€‚ | ç›®å½•ç©¿è¶Šæ”»å‡»ï¼ˆå¦‚ `../../../etc/passwd`ï¼‰ |
| **SSRF é˜²æŠ¤** | é›†æˆ `ssrf-protect` åº“éªŒè¯ä¸‹è½½ URLã€‚é˜»æ­¢è¯·æ±‚ç§æœ‰ IP èŒƒå›´ï¼ˆ10.xã€172.16.xã€192.168.xã€127.xï¼‰å’Œå†…éƒ¨ä¸»æœºåã€‚ | æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€  (SSRF) |
| **é‡å®šå‘ç»•è¿‡é˜²æŠ¤** | æ–‡ä»¶ä¸‹è½½æ—¶ç¦ç”¨ HTTP é‡å®šå‘ï¼ˆ`allow_redirects=False`ï¼‰ã€‚ | é€šè¿‡æ¶æ„é‡å®šå‘åˆ°å†…éƒ¨æœåŠ¡ç»•è¿‡ SSRF |
| **åŸå­å†™å…¥** | ä¸Šä¼ ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ + é‡å‘½åæ¨¡å¼ï¼Œé˜²æ­¢å¤±è´¥æ—¶äº§ç”Ÿéƒ¨åˆ†/æŸåæ–‡ä»¶ã€‚ | ä¼ è¾“ä¸­æ–­å¯¼è‡´çš„æ•°æ®æŸå |
| **æ–‡ä»¶å¤§å°é™åˆ¶** | å¼ºåˆ¶æ‰§è¡Œå•æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ 100MBï¼‰ï¼Œä½¿ç”¨æµå¼éªŒè¯ã€‚è¶…å‡ºé™åˆ¶æ—¶ç«‹å³ä¸­æ­¢ä¼ è¾“ã€‚ | ç£ç›˜è€—å°½æ”»å‡» |
| **ç¬¦å·é“¾æ¥æ”»å‡»é˜²æŠ¤** | ä½¿ç”¨ `nosymfollow` é€‰é¡¹ï¼ˆLinux 5.10+ï¼‰æŒ‚è½½è™šæ‹Ÿç£ç›˜ã€‚æŒ‚è½½å‰éªŒè¯æŒ‚è½½ç‚¹ä¸æ˜¯ç¬¦å·é“¾æ¥ã€‚ | åŸºäºç¬¦å·é“¾æ¥çš„æ²™ç®±é€ƒé€¸ |
| **å¹¶å‘æ§åˆ¶** | ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘æ–‡ä»¶æ“ä½œï¼Œé˜²æ­¢èµ„æºè€—å°½ã€‚ | é€šè¿‡å¹¶å‘ä¼ è¾“æ´ªæ°´è¿›è¡Œçš„ DoS æ”»å‡» |

## å¿«é€Ÿå¼€å§‹

### 1. å‰ææ¡ä»¶

-   [Docker](https://www.docker.com/) å’Œ [Docker Compose](https://docs.docker.com/compose/) å·²æ­£ç¡®å®‰è£…å¹¶æ­£åœ¨è¿è¡Œã€‚
-   ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ (å¦‚ cURL, Postman, æˆ– Python çš„ `httpx` åº“)ã€‚

### 2. å¯åŠ¨æœåŠ¡

é¡¹ç›®æä¾›äº†ä¾¿æ·çš„è„šæœ¬æ¥å¯åŠ¨ç¯å¢ƒã€‚æ‚¨å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è‡ªå®šä¹‰èµ„æºåˆ†é…å’Œå®ä¾‹æ± å¤§å°ã€‚

-   **Linux / macOS ç”¨æˆ·:** `sh start.sh [å‚æ•°]`
-   **Windows ç”¨æˆ· (PowerShell):** `.\start.ps1 [å‚æ•°]`

æœåŠ¡å¯åŠ¨åï¼Œç½‘å…³å°†åœ¨ `http://127.0.0.1:3874` ä¸Šç›‘å¬è¯·æ±‚ã€‚

#### è‡ªå®šä¹‰ç¯å¢ƒé…ç½®

æ‚¨å¯ä»¥åœ¨å¯åŠ¨è„šæœ¬åé™„åŠ ä»¥ä¸‹å‚æ•°æ¥é…ç½®ç³»ç»Ÿçš„è¡Œä¸ºã€‚

| å‚æ•° | Shell (`.sh`) | PowerShell (`.ps1`) | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- |
| æœ€å°ç©ºé—²å®ä¾‹ | `--min-idle-workers` | `-MinIdleWorkers` | `10` | æ± ä¸­ä¿æŒçš„æœ€å°ç©ºé—²ã€é¢„çƒ­çš„å·¥ä½œå®ä¾‹æ•°é‡ã€‚ |
| æœ€å¤§å®ä¾‹æ€»æ•° | `--max-total-workers`| `-MaxTotalWorkers` | `50` | ç³»ç»Ÿå…è®¸åˆ›å»ºçš„å¹¶å‘å·¥ä½œå®¹å™¨çš„æœ€å¤§æ€»æ•°ã€‚ |
| Worker CPU | `--worker-cpu` | `-WorkerCPU` | `1.5` | åˆ†é…ç»™æ¯ä¸ªå·¥ä½œå®¹å™¨çš„ CPU æ ¸å¿ƒæ•° (ä¾‹å¦‚ `1.5` ä»£è¡¨ä¸€ä¸ªåŠæ ¸å¿ƒ)ã€‚ |
| Worker å†…å­˜ | `--worker-ram-mb` | `-WorkerRAM_MB` | `1536` | åˆ†é…ç»™æ¯ä¸ªå·¥ä½œå®¹å™¨çš„å†…å­˜å¤§å° (å•ä½: MB)ã€‚ |
| Worker ç£ç›˜ | `--worker-disk-mb` | `-WorkerDisk_MB` | `500` | ä¸ºæ¯ä¸ªå·¥ä½œå®ä¾‹çš„æ²™ç®±æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºçš„è™šæ‹Ÿç£ç›˜å¤§å° (å•ä½: MB)ã€‚ |

> **æ³¨æ„**ï¼šé»˜è®¤èµ„æºé™åˆ¶å·²å¢åŠ ä»¥æ”¯æŒ Node.jsã€LibreOffice å’Œ Playwrightã€‚å¦‚æœéƒ¨ç½²æ—¶ä¸éœ€è¦è¿™äº›åŠŸèƒ½ï¼Œå¯ä»¥é€‚å½“é™ä½é™åˆ¶ã€‚

**ç¤ºä¾‹ (Linux/macOS):**
```bash
# å¯åŠ¨ä¸€ä¸ªæ‹¥æœ‰æ›´å¤§å®ä¾‹æ± å’Œæ›´å¼ºæ€§èƒ½å®ä¾‹çš„ç³»ç»Ÿ
sh start.sh --min-idle-workers 10 --worker-cpu 2.0 --worker-ram-mb 2048
```

**ç¤ºä¾‹ (Windows PowerShell):**
```powershell
# å¯åŠ¨ä¸€ä¸ªé€‚ç”¨äºä½èµ„æºç¯å¢ƒçš„è½»é‡çº§é…ç½®
.\start.ps1 -MinIdleWorkers 2 -MaxTotalWorkers 10 -WorkerCPU 0.5 -WorkerRAM_MB 512
```

### 3. è·å–è®¤è¯ä»¤ç‰Œ

ä»æ­£åœ¨è¿è¡Œçš„ç½‘å…³å®¹å™¨ä¸­è·å–è‡ªåŠ¨ç”Ÿæˆçš„ä»¤ç‰Œï¼š
```bash
docker exec code-interpreter_gateway cat /gateway/auth_token.txt
```
è¦è¿›è¡Œå¿«é€Ÿçš„ UI æµ‹è¯•ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é¡¹ç›®å†…çš„ `test.html` æ–‡ä»¶ï¼Œç²˜è´´ä»¤ç‰Œï¼Œç„¶åç‚¹å‡»â€œNew Sessionâ€ã€‚

### 4. åœæ­¢æœåŠ¡

-   **Linux / macOS ç”¨æˆ·:** `sh stop.sh`
-   **Windows ç”¨æˆ· (PowerShell):** `.\stop.ps1`

## API æ¥å£æ–‡æ¡£

æ‰€æœ‰ç«¯ç‚¹éƒ½ä»¥ `/api/v1` ä¸ºå‰ç¼€ã€‚æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦ `X-Auth-Token: <ä½ çš„ä»¤ç‰Œ>` è¯·æ±‚å¤´ã€‚

### 1. æ‰§è¡Œä»£ç  `POST /api/v1/execute?user_uuid={uuid}`
åœ¨ç”¨æˆ·çš„æœ‰çŠ¶æ€ä¼šè¯ä¸­æ‰§è¡Œ Python ä»£ç ã€‚
-   **æŸ¥è¯¢å‚æ•°**: `user_uuid` (å¿…éœ€) - ç”¨æˆ·ä¼šè¯çš„ UUID æ ‡è¯†ç¬¦
-   **è¯·æ±‚ä½“**: `{ "code": "string" }`
-   **æˆåŠŸå“åº” (200 OK)**: `{ "worker_id": "string", "result_text": "string | null", "result_base64": "string | null" }`
-   **è¶…æ—¶/å´©æºƒå“åº” (503/504)**: è¡¨ç¤ºå‘ç”Ÿäº†è‡´å‘½é”™è¯¯ã€‚ç¯å¢ƒå·²è¢«é”€æ¯å’Œå›æ”¶ã€‚

### 2. é‡Šæ”¾ä¼šè¯ `POST /api/v1/release?user_uuid={uuid}`
ä¸»åŠ¨ç»ˆæ­¢ä¸€ä¸ªç”¨æˆ·çš„ä¼šè¯å¹¶é”€æ¯å…¶å·¥ä½œå®ä¾‹ã€‚
-   **æŸ¥è¯¢å‚æ•°**: `user_uuid` (å¿…éœ€) - ç”¨æˆ·ä¼šè¯çš„ UUID æ ‡è¯†ç¬¦
-   **æˆåŠŸå“åº” (204 No Content)**

### 3. è·å–ç³»ç»ŸçŠ¶æ€ `GET /api/v1/status` (ç®¡ç†æ¥å£)
è¿”å›å·¥ä½œæ± çŠ¶æ€çš„æ‘˜è¦ä¿¡æ¯ï¼Œç”¨äºç›‘æ§ã€‚
-   **æˆåŠŸå“åº” (200 OK)**:
    ```json
    {
        "total_workers": 10,
        "busy_workers": 3,
        "is_initializing": false
    }
    ```

### 4. æ‰¹é‡ä¸Šä¼ æ–‡ä»¶åˆ°æ²™ç®± `POST /api/v1/files?user_uuid={uuid}`
ä»é¢„ç­¾å URL æ‰¹é‡ä¸‹è½½æ–‡ä»¶å¹¶ä¿å­˜åˆ°ç”¨æˆ·çš„å·¥ä½œå®ä¾‹æ²™ç®±ä¸­ã€‚æ”¯æŒå¹¶å‘å¤„ç†ã€‚
-   **æŸ¥è¯¢å‚æ•°**: `user_uuid` (å¿…éœ€) - ç”¨æˆ·ä¼šè¯çš„ UUID æ ‡è¯†ç¬¦
-   **é™åˆ¶**: æ¯æ¬¡è¯·æ±‚æœ€å¤š 100 ä¸ªæ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 100MB
-   **è¯·æ±‚ä½“**:
    ```json
    {
        "files": [
            {"download_url": "https://...", "path": "/sandbox/", "name": "data.xlsx"},
            {"download_url": "https://...", "path": "/sandbox/", "name": "image.png"}
        ]
    }
    ```
-   **æˆåŠŸå“åº” (201 Created)**:
    ```json
    {
        "success": true,
        "results": [
            {"full_path": "/sandbox/data.xlsx", "size": 12345},
            {"full_path": "/sandbox/image.png", "size": 67890}
        ]
    }
    ```

### 5. æ‰¹é‡ä»æ²™ç®±å¯¼å‡ºæ–‡ä»¶ `POST /api/v1/files/export?user_uuid={uuid}`
ä»æ²™ç®±è¯»å–æ–‡ä»¶å¹¶é€šè¿‡é¢„ç­¾å URL ä¸Šä¼ åˆ° OSSã€‚æ”¯æŒå¹¶å‘å¤„ç†ã€‚
-   **æŸ¥è¯¢å‚æ•°**: `user_uuid` (å¿…éœ€) - ç”¨æˆ·ä¼šè¯çš„ UUID æ ‡è¯†ç¬¦
-   **é™åˆ¶**: æ¯æ¬¡è¯·æ±‚æœ€å¤š 100 ä¸ªæ–‡ä»¶
-   **è¯·æ±‚ä½“**:
    ```json
    {
        "files": [
            {"path": "/sandbox/", "name": "result.xlsx", "upload_url": "https://..."},
            {"path": "/sandbox/", "name": "chart.png", "upload_url": "https://..."}
        ]
    }
    ```
-   **æˆåŠŸå“åº” (200 OK)**:
    ```json
    {
        "success": true,
        "results": [
            {"path": "/sandbox/", "name": "result.xlsx", "size": 8192},
            {"path": "/sandbox/", "name": "chart.png", "size": 54321}
        ]
    }
    ```

### 6. æ‰¹é‡åˆ é™¤æ²™ç®±æ–‡ä»¶ `DELETE /api/v1/files?user_uuid={uuid}`
æ‰¹é‡åˆ é™¤ç”¨æˆ·å·¥ä½œå®ä¾‹æ²™ç®±ä¸­çš„æ–‡ä»¶ã€‚
-   **æŸ¥è¯¢å‚æ•°**: `user_uuid` (å¿…éœ€) - ç”¨æˆ·ä¼šè¯çš„ UUID æ ‡è¯†ç¬¦
-   **é™åˆ¶**: æ¯æ¬¡è¯·æ±‚æœ€å¤š 100 ä¸ªæ–‡ä»¶
-   **è¯·æ±‚ä½“**:
    ```json
    {
        "files": [
            {"path": "/sandbox/", "name": "temp.xlsx"},
            {"path": "/sandbox/", "name": "old.png"}
        ]
    }
    ```
-   **æˆåŠŸå“åº” (204 No Content)**

## ä½¿ç”¨ç¤ºä¾‹ (Python)

```python
import httpx
import asyncio
import uuid
import base64
import subprocess

GATEWAY_URL = "http://127.0.0.1:3874"
USER_ID = str(uuid.uuid4())

def get_auth_token():
    try:
        return subprocess.check_output(
            ["docker", "exec", "code-interpreter_gateway", "cat", "/gateway/auth_token.txt"],
            text=True
        ).strip()
    except Exception:
        print("âŒ æ— æ³•è·å– Auth Tokenã€‚æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ï¼Ÿ")
        return None

async def execute_code(client: httpx.AsyncClient, code: str):
    print(f"\n--- æ­£åœ¨æ‰§è¡Œ ---\n{code.strip()}")
    try:
        response = await client.post(
            f"{GATEWAY_URL}/api/v1/execute",
            params={"user_uuid": USER_ID},
            json={"code": code},
            timeout=30.0
        )
        response.raise_for_status()
        data = response.json()
        if data.get("result_text"):
            print(">>> æ–‡æœ¬ç»“æœ:\n" + data["result_text"])
        if data.get("result_base64"):
            print(">>> æˆåŠŸç”Ÿæˆå›¾åƒï¼(å·²ä¿å­˜ä¸º output.png)")
            with open("output.png", "wb") as f:
                f.write(base64.b64decode(data["result_base64"]))
    except httpx.HTTPStatusError as e:
        print(f"æ‰§è¡Œå¤±è´¥: {e.response.status_code} - {e.response.text}")

async def main():
    token = get_auth_token()
    if not token: return
    
    headers = {"X-Auth-Token": token}
    async with httpx.AsyncClient(headers=headers) as client:
        # æ­¥éª¤ 1: å®šä¹‰ä¸€ä¸ªå˜é‡
        await execute_code(client, "a = 100")
        # æ­¥éª¤ 2: ä½¿ç”¨ä¸Šä¸€æ­¥çš„å˜é‡ (çŠ¶æ€è¢«ä¿æŒ)
        await execute_code(client, "print(f'å˜é‡ a çš„å€¼æ˜¯ {a}')")

if __name__ == "__main__":
    asyncio.run(main())
```